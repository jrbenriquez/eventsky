{% extends "base.html" %}
{% block head %}
    <title>{{ event.title }}</title>
{% endblock %}
{% block body %}
    <body class="bg-gray-50 h-[100svh] overflow-hidden flex flex-col">
        <!-- Event Header -->
        <header id="eventTitle"
                class="sticky top-0 bg-gray-50 z-10 text-center px-4 pt-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">{{ event.title }}</h1>
            <p class="text-gray-600 mt-2 text-base">{{ event.description }}</p>
            <small class="text-xs text-gray-400 block mt-1">Created at: {{ event.created_at }}</small>
            <div class="flex justify-around m-1 cursor-pointer">
                <svg onClick="toggleQrCodeModal()"
                     title="View QR Code"
                     xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke-width="1.5"
                     stroke="currentColor"
                     class="size-6 hover:shadow-lg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
                </svg>
            </div>
        </header>
        <!-- Messages -->
        <div class="overflow-y-auto h-full">
        <div id="pinnedMessages"
              class="w-full flex-1 mx-auto pt-8 px-4 space-y-3 max-w-xl sm:max-w-2xl lg:max-w-3xl scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden">
            {% with messages=pinned_messages, hide_empty_prompt=True %}
              {% include "_messages.html" %}
            {% endwith %}
        </div>
        <main id="messages"
              class="w-full flex-1 mx-auto pt-8 px-4 pb-36 space-y-3 max-w-xl sm:max-w-2xl lg:max-w-3xl scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
              hx-ext="sse"
              sse-connect="/events/{{ event.code }}/stream"
              sse-swap="message"
              hx-vals='{"context": "new"}'
              hx-swap="afterbegin">
            {% include "_messages.html" %}
            {% if messages %}
                <div id="infinite-scroll"
                     hx-get="/events/{{ event.code }}/check_older/?before_id={{ messages[-1].uuid }}&limit=10"
                     hx-trigger="load"
                     hx-swap="outerHTML"></div>
            {% endif %}
        </main>
        </div>
        {% if not event.posting_messages_disabled %}
        <!-- Fixed bottom input -->
        <div class="sticky bottom-0 left-0 w-full bg-white py-3 shadow-inner">
            <form hx-post="/message/{{ event.code }}/"
                  class="mx-auto w-full px-4 max-w-xl sm:max-w-2xl lg:max-w-3xl"
                  hx-swap="none"
                  hx-on="htmx:beforeRequest: if (!ensureGuestName(event)) { return; };
                         htmx:afterRequest: if (event.detail.successful) {
                        clearMessageForm();
                        handleAfterSubmit();
                        startSendCooldown(15);
                      }
                    "
                  >

                <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 bg-white">
                    <!-- Upload Icon with badge -->
                    <div class="relative inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 shrink-0">
                        <button type="button"
                                onclick="uploadFile('cameraInput')"
                                title="Use camera"
                                class="inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 p-0 leading-none text-gray-500 hover:text-gray-700">
                            <svg id="cameraIcon" xmlns="http://www.w3.org/2000/svg"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke-width="1.5"
                                 stroke="currentColor"
                                 class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                            </svg>
                        </button>
                        <!-- Badge (kept absolute) -->
                        <span id="cameraBadge"
                              class="pointer-events-none absolute -top-1 -right-1 h-4 w-4 rounded-full bg-red-500 text-white text-[10px] leading-none flex items-center justify-center hidden">
                        </span>
                    </div>
                    <!-- Upload Icon with badge -->
                    <div class="relative inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 shrink-0">
                        <button type="button"
                                onclick="uploadFile('fileInput')"
                                title="Upload photo"
                                class="inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 p-0 leading-none text-gray-500 hover:text-gray-700">
                            <svg id="fileIcon" xmlns="http://www.w3.org/2000/svg"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke-width="1.5"
                                 stroke="currentColor"
                                 class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                            </svg>
                        </button>
                        <!-- Badge (kept absolute) -->
                        <span id="fileBadge"
                              class="pointer-events-none absolute -top-1 -right-1 h-4 w-4 rounded-full bg-red-500 text-white text-[10px] leading-none flex items-center justify-center hidden">
                        </span>
                    </div>
                    <!-- File Input for Image -->
                    <input type="file"
                           id="cameraInput"
                           accept="image/*"
                           capture="environment"
                           class="hidden"
                           onchange="handleFileUpload(event, 'cameraBadge', 'camera')" />
                    <input type="file"
                           id="fileInput"
                           accept="image/*"
                           multiple
                           class="hidden"
                           onchange="handleFileUpload(event, 'fileBadge', 'upload')" />
                    <input type="hidden" id="guestNameField" name="sender_name" value="">
                    <div class="flex flex-col w-full pl-2">
                        <!-- Previews will be injected here -->
                        <div id="imagePreviewBar"
                             class="flex gap-2 px-3 py-2 pb-4 overflow-x-auto max-w-full hidden"></div>
                        <div class="flex">
                            <!-- Text Input -->
                            <input id="msgText"
                                   type="text"
                                   name="text"
                                   placeholder="Type your message..."
                                   oninput="updateSendDisabled()"
                                   class="flex-1 text-base sm:text-base border-none outline-none bg-transparent" />
                            <!-- Send Button (Heroicon Paper Airplane) -->
                            <button id="sendBtn"
                                    type="submit"
                                    class="text-blue-500 hover:text-blue-700 shrink-0 disabled:opacity-40 disabled:cursor-not-allowed"
                                    title="Send message">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="h-5 w-5 sm:h-6 sm:w-6"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
        {% include "_lightbox.html" %}
        <!-- Overlay for guest name -->
        <div id="nameOverlay"
             class="fixed inset-0 z-[99999] bg-black/70 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-3">Hi there! Please enter your name</h2>
                <p class="text-sm text-gray-600 mb-4">We'll remember this for next time.</p>
                <input id="guestNameInput"
                       type="text"
                       placeholder="Your name"
                       class="w-full border border-gray-300 rounded px-3 py-2 mb-4 focus:outline-none focus:ring"
                       onkeypress="if(event.key==='Enter'){saveGuestName()}">
                <button onclick="saveGuestName()"
                        class="w-full bg-black hover:bg-gray-600 text-white font-semibold py-2 rounded disabled:opacity-50">
                    Save
                </button>
            </div>
        </div>
        <!-- QR Code Modal -->
        <div id="qrCodeModal"
             class="fixed inset-0 z-50 grid place-content-center bg-black/50 p-4 hidden"
             role="dialog"
             aria-modal="true"
             aria-labelledby="modalTitle">
            <div class="w-full max-w-md rounded-lg bg-white p-6 shadow-lg">
                <div id="eventLink"
                     class="flex align-center text-center space-x-2 mt-4 cursor-pointer"
                     onClick="copyLinktoClipboard()">
                    <span type="text" disabled id="eventLinkText" class="text-sm text-grey-500">{{ event_url }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke-width="1.5"
                         stroke="currentColor"
                         class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z" />
                    </svg>
                </div>
                <hr class="border-gray-200 my-3" />
                <div id="qrcode" class="flex justify-around items-center"></div>
                <div class="flex justify-around items-center gap-1 my-3">
                    <div class="flex underline gap-1 cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor"
                             class="size-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <button type="button"
                                id="qrDownloadBtn"
                                class="rounded bg-transparent text-black"
                                onClick="downloadQr()">Download</button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1 text-center">On iPhone: you can tap &amp; hold the QR to save</p>
                <hr class="border-gray-200 my-3" />
                <div class="text-center mt-4">
                    <a class="inline-block rounded-sm border border-black bg-black px-12 py-3 text-sm font-medium text-white hover:bg-transparent hover:text-black focus:ring-3 focus:outline-hidden"
                       href="#"
                       onClick="toggleQrCodeModal()">Close</a>
                </div>
            </div>
        </div>
    </body>
{% endblock %}
{% block scripts %}
    <script>
      function uploadFile(inputId) {
        document.getElementById(inputId).click();
      }

      function updatePreviewBarVisibility() {
            function togglePreviewBar() {
              const bar = document.getElementById('imagePreviewBar');
              if (bar) {
                bar.classList.toggle('hidden');
              }
            }
        const bar = document.getElementById('imagePreviewBar');
        if (!bar) return;

        const hasImages = document.querySelectorAll('input[name="image_keys"]').length > 0;

        if (hasImages) {
          bar.classList.remove('hidden');   // show
        } else {
          bar.classList.add('hidden');      // hide
        }
      }

      function addImageKey(key, source) {
          const form = document.querySelector('form');
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'image_keys';
          input.classList.add(source === 'camera' ? 'camera' : 'upload');
          input.value = key;
          form.appendChild(input);
      }
      function removeImageKey(key) {
        document.querySelectorAll(`input[name="image_keys"][value="${CSS.escape(key)}"]`).forEach(n => n.remove());
        document.querySelector(`#imagePreviewBar [data-key="${CSS.escape(key)}"]`)?.remove();
        updateBadges("cameraBadge", "camera");
        updateBadges("fileBage", "upload");
        updatePreviewBarVisibility();
      }

      function addToPreviewBar(key) {
        // Tell the server which key and source (camera|upload) to render
          htmx.ajax('GET', `/messageimagepreview/?key=${encodeURIComponent(key)}`, {
            target: '#imagePreviewBar',
            swap: 'beforeend'      // append the new thumb
          });
      }

      async function processFile(file, source) {
        const extension = file.name.split('.').pop().toLowerCase();
        const iconId = source === 'camera' ? 'cameraIcon' : 'fileIcon';
        const icon = document.getElementById(iconId);
        icon.classList.add('animate-spin');

        try {
          const res = await fetch("/r2/presign-upload", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              extension: extension,
              content_type: file.type,
            }),
          });

          if (!res.ok) {
            throw new Error("Failed to get presigned URL");
          }

          const { upload_url, key } = await res.json();

          // Step 2: Upload file to R2 via presigned URL
          await fetch(upload_url, {
            method: "PUT",
            headers: {
              "Content-Type": file.type,
            },
            body: file,
          });

          addImageKey(key, source);
          addToPreviewBar(key);
          updatePreviewBarVisibility();
          icon.classList.remove('animate-spin');


        } catch (err) {
          console.error("Upload failed:", err);
        }

      }

      function updateBadges(elementId, source) {
        // After uploading, update the badge based on how many image_keys belong to this source
        const badge = document.getElementById(elementId);
        const count = document.querySelectorAll(`input[name="image_keys"].${source}`).length;
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }

      }

      async function handleFileUpload(event, elementId, source) {
        const files = event.target.files;

        if (!files) return;

        await Promise.all(Array.from(files).map(f => processFile(f, source)));
        updateBadges(elementId, source);
        // Clear input so change fires next time with same file(s)
        event.target.value = '';

      }

    function handleAfterSubmit() {
      {% if not messages %}
        document.getElementById('empty-state')?.remove();
      {% endif %}
      const el = document.getElementById("messages");
      if (el) el.scrollTop = 0; // top for timeline
    }
    function updateSendDisabled() {
      const textOk = (document.getElementById('msgText')?.value || '').trim().length > 0;
      const guestName = document.getElementById('guestNameField').value.trim();
      const guestNameOk = guestName.length > 0;
      const storedName = (localStorage.getItem('guestName') || '').trim();
      const storedNameOk = storedName.length >0;
      const btn = document.getElementById('sendBtn');
      // Using this less chances of guests encountering bugs
      if (btn) btn.disabled = !(textOk && guestNameOk);
      // Use this one if we are going with more improvements
      // if (btn) btn.disabled = !(textOk && guestNameOk && storedNameOk && storedName === guestName);
    }

      {% if not event.posting_messages_disabled %}
      // init on load
      updateSendDisabled();
      {% endif %}
    </script>
    {% if not event.posting_messages_disabled %}
    <script>
      // Save guest name script
      document.addEventListener("DOMContentLoaded", () => {
        const savedName = localStorage.getItem("guestName");
        if (!savedName) {
          document.getElementById("nameOverlay").classList.remove("hidden");
        } else {
          addNameToForm(savedName);
          updateMsgPlaceholder(savedName);
        }
      });

      function saveGuestName() {
        const input = document.getElementById("guestNameInput");
        const name = input.value.trim();
        if (!name) return;

        localStorage.setItem("guestName", name);
        addNameToForm(name);
        updateMsgPlaceholder(name);
        document.getElementById("nameOverlay").classList.add("hidden");
        updateSendDisabled();
      }

      function addNameToForm(name) {
        document.getElementById("guestNameField").value = name;
      };
      function updateMsgPlaceholder(name) {
        const msgField = document.getElementById("msgText");
        if (msgField) {
          msgField.placeholder = `Sending as ${name}`;
        }
      }

      function ensureGuestName(evt){
          const name = (localStorage.getItem('guestName') || '').trim();
          if (!name){
            evt.preventDefault(); // blocks the HTMX request
            document.getElementById('nameOverlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('guestNameInput')?.focus(), 0);
            return false;
          }
          ensureNameInForm();
          return true;
      }
      function ensureNameInForm(){
        const name = (localStorage.getItem('guestName') || '').trim();
        const field = document.getElementById('guestNameField');
        if (field && name) field.value = name;
      }
      // Keep placeholder in sync if guestName changes in another tab
      window.addEventListener('storage', (e) => {
        if (e.key === 'guestName') {
          const newName = e.newValue || '';
          addNameToForm(newName);
          updateMsgPlaceholder(newName);
          updateSendDisabled();
        }
      });
      function clearMessageForm() {
        var bar = document.getElementById('imagePreviewBar');
        if (bar) bar.classList.add('hidden');

        // clear text input
        var msgText = document.getElementById('msgText');
        if (msgText) msgText.value = '';

        // clear file inputs
        var fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.value = '';
        var cameraInput = document.getElementById('cameraInput');
        if (cameraInput) cameraInput.value = '';

        // remove any dynamically added image_keys inputs (with fallback for old Safari)
        var keys = document.querySelectorAll('input[name="image_keys"]');
        for (var i = 0; i < keys.length; i++) {
          if (typeof keys[i].remove === 'function') keys[i].remove();
          else if (keys[i].parentNode) keys[i].parentNode.removeChild(keys[i]);
        }

        // hide badges
        var fileBadge = document.getElementById('fileBadge');
        var cameraBadge = document.getElementById('cameraBadge');
        if (fileBadge) fileBadge.classList.add('hidden');
        if (cameraBadge) cameraBadge.classList.add('hidden');


        // clear previews (fallback if replaceChildren not supported)
        var previewBar = document.getElementById('imagePreviewBar');
        if (previewBar) {
          if (typeof previewBar.replaceChildren === 'function') previewBar.replaceChildren();
          else previewBar.innerHTML = '';
        }
      }
    </script>
    {% endif %}
    <script>
      dayjs.extend(dayjs_plugin_utc);

      function formatMsgTimes(root) {
        root.querySelectorAll('.msgTime').forEach(el => {
          el.textContent = dayjs.utc(el.dataset.utc).local().format('MMM D, YYYY h:mm A');
        });
      }

      // Initial page load
      document.addEventListener('DOMContentLoaded', () => formatMsgTimes(document));

      // Any new fragment loaded by HTMX (SSE, infinite scroll, etc.)
      if (window.htmx) {
        htmx.onLoad((fragment) => {
          formatMsgTimes(fragment);
        });
      }
    </script>
    <script>
      // COOLDOWN MECHANISM

        let isCooldown = false;
        const COOLDOWN_KEY = "lastMessageSentAt"; // localStorage key
        let cooldownTimer = null;


      // LISTENERS
        document.addEventListener("DOMContentLoaded", () => {
          const lastSent = parseInt(localStorage.getItem(COOLDOWN_KEY) || "0", 10);
          const remaining = lastSent + 15000 - Date.now();
          if (remaining > 0) {
            startSendCooldown(Math.ceil(remaining / 1000));
          }
        });
        // Prevent Enter key submission during cooldown
        const msgTxtElement = document.getElementById('msgText')
        if (msgTxtElement) {
          msgTxtElement.addEventListener('keydown', function(event) {
            if (isCooldown && event.key === 'Enter') {
              event.preventDefault();
            }
          });
        }


        function ensureNotCooling(evt) {
          const lastSent = parseInt(localStorage.getItem(COOLDOWN_KEY) || "0", 10);
          const remaining = lastSent + 15000 - Date.now();
          if (remaining > 0) {
            evt.preventDefault();
            startSendCooldown(Math.ceil(remaining / 1000));
            return false;
          }
          return true;
        }

        function startSendCooldown(seconds = 15) {
          isCooldown = true
          const endAt = Date.now() + seconds * 1000;
          localStorage.setItem(COOLDOWN_KEY, Date.now().toString());

          const btn = document.getElementById("sendBtn");
          if (!btn) return;

          // Store original content once
          if (!btn.dataset.original) btn.dataset.original = btn.innerHTML;

          btn.disabled = true;

          function tick() {
            const remaining = Math.max(0, Math.ceil((endAt - Date.now()) / 1000));
            if (remaining > 0) {
              btn.textContent = `${remaining}`;
            } else {
              clearInterval(cooldownTimer);
              cooldownTimer = null;
              btn.disabled = false;
              btn.innerHTML = btn.dataset.original;
              isCooldown = false
            }
          }

          tick();
          if (cooldownTimer) clearInterval(cooldownTimer);
          cooldownTimer = setInterval(tick, 1000);
        }
    </script>
    <script type="text/javascript">
      new QRCode(document.getElementById("qrcode"), "{{event_url}}");

      function toggleQrCodeModal() {
        document.getElementById("qrCodeModal").classList.toggle("hidden")
      }

      function copyLinktoClipboard() {
        navigator.clipboard.writeText("{{event_url}}");
        alert("Copied the text: " + "{{event_url}}");
      }
      function downloadQr(filename = "qr.png") {
          const host = document.getElementById("qrcode");
          const node = host.querySelector("canvas, img");
          if (!node) return;

          let dataURL;
          if (node.tagName.toLowerCase() === "canvas") {
            // Canvas ? PNG data URL
            dataURL = node.toDataURL("image/png");
          } else {
            // <img src="data:image/png;base64,..."> already
            dataURL = node.src;
          }

          const a = document.createElement("a");
          a.href = dataURL;
          a.download = filename;   // iOS Safari ignores sometimes for non-user gesture; still opens image
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
    </script>

{% with preview_mode=('/preview/' in request.path or '/preview/' in request.headers['hx-current-url']) %}
  {% if preview_mode %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    alert('Images are blurred when in Preview mode. Some of the images changed orientation after blurring sorry bout that :)');
});
  </script>
  {% endif %}
{% endwith %}
{% endblock %}
