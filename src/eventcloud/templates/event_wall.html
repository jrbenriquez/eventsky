<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport"
              content="width=device-width, initial-scale=1, viewport-fit=cover">
        <title>{{ event.title }}</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
        <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
        <style>html{-webkit-text-size-adjust:100%}</style>
    </head>
    <body class="bg-gray-50 h-[100svh] overflow-hidden flex flex-col">
        <!-- Event Header -->
        <header id="eventTitle"
                class="sticky top-0 bg-gray-50 z-10 text-center px-4 pt-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">{{ event.title }}</h1>
            <p class="text-gray-600 mt-2 text-base">{{ event.description }}</p>
            <small class="text-xs text-gray-400 block mt-1">Created at: {{ event.created_at }}</small>
        </header>
        <!-- Messages -->
        <main id="messages"
              class="w-full flex-1 overflow-y-auto mx-auto pt-8 px-4 pb-36 space-y-3 max-w-xl sm:max-w-2xl lg:max-w-3xl scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
              hx-ext="sse"
              sse-connect="/event/{{ event.code }}/stream"
              sse-swap="message"
              hx-vals='{"context": "new"}'
              hx-swap="afterbegin">
            {% include "_messages.html" %}
            {% if messages %}
                <div id="infinite-scroll"
                     hx-get="/event/{{ event.code }}/check_older/?before_id={{ messages[-1].uuid }}&limit=10"
                     hx-trigger="load"
                     hx-swap="outerHTML"></div>
            {% endif %}
        </main>
        <!-- Fixed bottom input -->
        <div class="sticky bottom-0 left-0 w-full bg-white py-3 shadow-inner">
            <form hx-post="/message/{{ event.code }}/"
                  class="mx-auto w-full px-4 max-w-xl sm:max-w-2xl lg:max-w-3xl"
                  hx-swap="none"
                  hx-on=" htmx:beforeRequest: if(!ensureGuestName(event)){return}; htmx:afterRequest: clearMessageForm(); handleAfterSubmit(); ">
                <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 bg-white">
                    <!-- Upload Icon with badge -->
                    <div class="relative inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 shrink-0">
                        <button type="button"
                                onclick="uploadFile('cameraInput')"
                                title="Use camera"
                                class="inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 p-0 leading-none text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke-width="1.5"
                                 stroke="currentColor"
                                 class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                            </svg>
                        </button>
                        <!-- Badge (kept absolute) -->
                        <span id="cameraBadge"
                              class="pointer-events-none absolute -top-1 -right-1 h-4 w-4 rounded-full bg-red-500 text-white text-[10px] leading-none flex items-center justify-center hidden">
                        </span>
                    </div>
                    <!-- Upload Icon with badge -->
                    <div class="relative inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 shrink-0">
                        <button type="button"
                                onclick="uploadFile('fileInput')"
                                title="Upload photo"
                                class="inline-flex items-center justify-center w-6 h-6 sm:w-7 sm:h-7 p-0 leading-none text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke-width="1.5"
                                 stroke="currentColor"
                                 class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                            </svg>
                        </button>
                        <!-- Badge (kept absolute) -->
                        <span id="fileBadge"
                              class="pointer-events-none absolute -top-1 -right-1 h-4 w-4 rounded-full bg-red-500 text-white text-[10px] leading-none flex items-center justify-center hidden">
                        </span>
                    </div>
                    <!-- File Input for Image -->
                    <input type="file"
                           id="cameraInput"
                           accept="image/*"
                           capture="environment"
                           class="hidden"
                           onchange="handleFileUpload(event, 'cameraBadge', 'camera')" />
                    <input type="file"
                           id="fileInput"
                           accept="image/*"
                           multiple
                           class="hidden"
                           onchange="handleFileUpload(event, 'fileBadge', 'upload')" />
                    <input type="hidden" id="guestNameField" name="sender_name" value="">
                    <div id="imagePreviewBar"
                         class="flex gap-2 px-3 py-2 overflow-x-auto max-w-full">
                        <!-- Previews will be injected here -->
                    </div>
                    <!-- Text Input -->
                    <input id="msgText"
                           type="text"
                           name="text"
                           placeholder="Type your message..."
                           oninput="updateSendDisabled()"
                           class="flex-1 text-base sm:text-base border-none outline-none bg-transparent" />
                    <!-- Send Button (Heroicon Paper Airplane) -->
                    <button id="sendBtn"
                            type="submit"
                            class="text-blue-500 hover:text-blue-700 shrink-0 disabled:opacity-40 disabled:cursor-not-allowed"
                            title="Send message">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-5 w-5 sm:h-6 sm:w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </form>
        </div>
        <div id="lightbox"
             class="fixed inset-0 z-[9999] hidden bg-black/80 p-4 flex items-center justify-center">
            <button id="lightbox-close"
                    class="absolute top-3 right-3 rounded-full bg-white/90 px-3 py-1 text-sm text-gray-800 shadow">
                Close
            </button>
            <img id="lightbox-img"
                 alt=""
                 class="max-w-full max-h-full rounded-lg object-contain select-none" />
        </div>
        <!-- Overlay for guest name -->
        <div id="nameOverlay"
             class="fixed inset-0 z-[99999] bg-black/70 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-3">Hi there! Please enter your name</h2>
                <p class="text-sm text-gray-600 mb-4">We'll remember this for next time.</p>
                <input id="guestNameInput"
                       type="text"
                       placeholder="Your name"
                       class="w-full border border-gray-300 rounded px-3 py-2 mb-4 focus:outline-none focus:ring"
                       onkeypress="if(event.key==='Enter'){saveGuestName()}">
                <button onclick="saveGuestName()"
                        class="w-full bg-black hover:bg-gray-600 text-white font-semibold py-2 rounded disabled:opacity-50">
                    Save
                </button>
            </div>
        </div>
    </body>
    <script>
      function uploadFile(inputId) {
        document.getElementById(inputId).click();
      }

      function addImageKey(key, source) {
          const form = document.querySelector('form');
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'image_keys';
          input.classList.add(source === 'camera' ? 'camera' : 'upload');
          input.value = key;
          form.appendChild(input);
      }
      function removeImageKey(key) {
        document.querySelectorAll(`input[name="image_keys"][value="${CSS.escape(key)}"]`).forEach(n => n.remove());
        document.querySelector(`#imagePreviewBar [data-key="${CSS.escape(key)}"]`)?.remove();
        updateBadges("cameraBadge", "camera");
        updateBadges("fileBage", "upload");
      }

      function addToPreviewBar(key) {
        // Tell the server which key and source (camera|upload) to render
          htmx.ajax('GET', `/messageimagepreview/?key=${encodeURIComponent(key)}`, {
            target: '#imagePreviewBar',
            swap: 'beforeend'      // append the new thumb
          });
      }

      async function processFile(file, source) {
        const extension = file.name.split('.').pop().toLowerCase();

        try {
          const res = await fetch("/r2/presign-upload", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              extension: extension,
              content_type: file.type,
            }),
          });

          if (!res.ok) {
            throw new Error("Failed to get presigned URL");
          }

          const { upload_url, key } = await res.json();

          // Step 2: Upload file to R2 via presigned URL
          await fetch(upload_url, {
            method: "PUT",
            headers: {
              "Content-Type": file.type,
            },
            body: file,
          });

          addImageKey(key, source);
          addToPreviewBar(key);

        } catch (err) {
          console.error("Upload failed:", err);
        }

      }

      function updateBadges(elementId, source) {
        // After uploading, update the badge based on how many image_keys belong to this source
        const badge = document.getElementById(elementId);
        const count = document.querySelectorAll(`input[name="image_keys"].${source}`).length;
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }

      }

      async function handleFileUpload(event, elementId, source) {
        const files = event.target.files;

        if (!files) return;

        await Promise.all(Array.from(files).map(f => processFile(f, source)));
        updateBadges(elementId, source);
        // Clear input so change fires next time with same file(s)
        event.target.value = '';

      }

    function handleAfterSubmit() {
      {% if not messages %}
        document.getElementById('empty-state')?.remove();
      {% endif %}
      document.getElementById('fileBadge')?.classList.add('hidden');; 
      document.getElementById('cameraBadge')?.classList.add('hidden');; 
      const el = document.getElementById("messages");
      if (el) el.scrollTop = 0; // top for timeline
    }
    function updateSendDisabled() {
      const textOk = (document.getElementById('msgText')?.value || '').trim().length > 0;
      const guestName = document.getElementById('guestNameField').value.trim();
      const guestNameOk = guestName.length > 0;
      const storedName = (localStorage.getItem('guestName') || '').trim();
      const storedNameOk = storedName.length >0;
      const btn = document.getElementById('sendBtn');
      // Using this less chances of guests encountering bugs
      if (btn) btn.disabled = !(textOk && guestNameOk);
      // Use this one if we are going with more improvements
      // if (btn) btn.disabled = !(textOk && guestNameOk && storedNameOk && storedName === guestName);
    }
      // init on load
      updateSendDisabled();
    </script>
    <script>
    function openLightbox(src){ const lb=document.getElementById('lightbox'); const img=document.getElementById('lightbox-img'); img.src=src; lb.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
    function closeLightbox(){ const lb=document.getElementById('lightbox'); const img=document.getElementById('lightbox-img'); lb.classList.add('hidden'); img.src=''; document.body.classList.remove('overflow-hidden'); }

    // Open on click (delegated so HTMX/SSE inserts work)
    document.addEventListener('click', (e) => {
      const t = e.target.closest('[data-lightbox-src]');
      if (t) { e.preventDefault(); openLightbox(t.getAttribute('data-lightbox-src') || t.src); }
    });

    // Close on overlay click / button / Esc
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox' || e.target.id === 'lightbox-close') closeLightbox();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
    </script>
    <script>
      // Save guest name script
      document.addEventListener("DOMContentLoaded", () => {
        const savedName = localStorage.getItem("guestName");
        if (!savedName) {
          document.getElementById("nameOverlay").classList.remove("hidden");
        } else {
          addNameToForm(savedName);
          updateMsgPlaceholder(savedName);
        }
      });

      function saveGuestName() {
        const input = document.getElementById("guestNameInput");
        const name = input.value.trim();
        if (!name) return;

        localStorage.setItem("guestName", name);
        addNameToForm(name);
        updateMsgPlaceholder(name);
        document.getElementById("nameOverlay").classList.add("hidden");
        updateSendDisabled();
      }

      function addNameToForm(name) {
        document.getElementById("guestNameField").value = name;
      };
      function updateMsgPlaceholder(name) {
        const msgField = document.getElementById("msgText");
        if (msgField) {
          msgField.placeholder = `Sending message as ${name}`;
        }
      }

      function ensureGuestName(evt){
          const name = (localStorage.getItem('guestName') || '').trim();
          if (!name){
            evt.preventDefault(); // blocks the HTMX request
            document.getElementById('nameOverlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('guestNameInput')?.focus(), 0);
            return false;
          }
          ensureNameInForm();
          return true;
      }
      function ensureNameInForm(){
        const name = (localStorage.getItem('guestName') || '').trim();
        const field = document.getElementById('guestNameField');
        if (field && name) field.value = name;
      }
      // Keep placeholder in sync if guestName changes in another tab
      window.addEventListener('storage', (e) => {
        if (e.key === 'guestName') {
          const newName = e.newValue || '';
          addNameToForm(newName);
          updateMsgPlaceholder(newName);
          updateSendDisabled();
        }
      });
      function clearMessageForm() {
        // clear text input
        const msgText = document.getElementById('msgText');
        if (msgText) msgText.value = '';

        // clear file input
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.value = '';

        // clear camera input
        const cameraInput = document.getElementById('cameraInput');
        if (cameraInput) cameraInput.value = '';

        // remove any dynamically added image_keys inputs
        document.querySelectorAll('input[name="image_keys"]').forEach(n => n.remove());

        // hide the file badge
        const badge = document.getElementById('fileBadge');
        if (badge) badge.classList.add('hidden');

        // keep guest name as-is but ensure hidden field is synced
        const name = (localStorage.getItem('guestName') || '').trim();
        const guestNameField = document.getElementById('guestNameField');
        if (guestNameField) guestNameField.value = name;

        // update placeholder
        if (msgText && name) {
          msgText.placeholder = `Sending message as ${name}`;
        }
        // clear previews
        document.querySelectorAll('input[name="image_keys"]').forEach(n => n.remove());
        document.getElementById('imagePreviewBar')?.replaceChildren(); // clear thumbs

        //hide badges
        document.getElementById('fileBadge')?.classList.add('hidden');
        document.getElementById('cameraBadge')?.classList.add('hidden');

      }
    </script>
    <script>
      dayjs.extend(dayjs_plugin_utc);

      function formatMsgTimes(root) {
        root.querySelectorAll('.msgTime').forEach(el => {
          el.textContent = dayjs.utc(el.dataset.utc).local().format('MMM D, YYYY h:mm A');
        });
      }

      // Initial page load
      document.addEventListener('DOMContentLoaded', () => formatMsgTimes(document));

      // Any new fragment loaded by HTMX (SSE, infinite scroll, etc.)
      if (window.htmx) {
        htmx.onLoad((fragment) => {
          formatMsgTimes(fragment);
        });
      }
    </script>
</html>
